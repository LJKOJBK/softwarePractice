{"version":3,"sources":["GridView.js"],"names":["cc","Class","extends","Component","properties","aniPre","default","type","Prefab","effectLayer","Node","audioUtils","AudioUtils","onLoad","setListener","lastTouchPos","Vec2","isCanMove","isInPlayAni","setController","controller","initWithCellModels","cellsModels","cellViews","i","j","aniView","instantiate","parent","node","cellViewScript","getComponent","initWithModel","on","EventType","TOUCH_START","e","cellPos","convertTouchPosToCell","getLocation","selectCell","TOUCH_MOVE","startCellPos","getStartLocation","x","y","pos","convertToNodeSpace","GRID_PIXEL_WIDTH","GRID_PIXEL_HEIGHT","Math","floor","CELL_WIDTH","CELL_HEIGHT","v2","updateView","changeModels","newCellViewInfo","model","viewInfo","findViewByModel","view","cellScript","isDeath","push","forEach","ele","updateSelect","setSelect","getPlayAniTime","maxTime","cmd","playTime","keepTime","getStep","effectsQueue","reduce","maxValue","efffectCmd","max","step","disableTouch","time","runAction","sequence","delayTime","callFunc","playContinuousMatch","result","playEffect","cleanCmd","length","playSwap","playClick","playEffects"],"mappings":"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","file":"GridView.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\Script\\View","sourcesContent":["import { CELL_WIDTH, CELL_HEIGHT, GRID_PIXEL_WIDTH, GRID_PIXEL_HEIGHT, ANITIME } from '../Model/ConstValue';\r\n\r\nimport AudioUtils from \"../Utils/AudioUtils\";\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        // foo: {\r\n        //    default: null,      // The default value will be used only when the component attaching\r\n        //                           to a node for the first time\r\n        //    url: cc.Texture2D,  // optional, default is typeof default\r\n        //    serializable: true, // optional, default is true\r\n        //    visible: true,      // optional, default is true\r\n        //    displayName: 'Foo', // optional\r\n        //    readonly: false,    // optional, default is false\r\n        // },\r\n        // ...\r\n\r\n        // 记录所有预设动物元素\r\n        aniPre: {\r\n            default: [],\r\n            type: [cc.Prefab]\r\n        },\r\n        effectLayer: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n        audioUtils: {\r\n            type: AudioUtils,\r\n            default: null\r\n        }\r\n\r\n    },\r\n\r\n\r\n    // use this for initialization\r\n    onLoad: function () {\r\n        this.setListener(); // 所有事件监听\r\n        this.lastTouchPos = cc.Vec2(-1, -1);\r\n        this.isCanMove = true;\r\n        this.isInPlayAni = false; // 是否在播放中\r\n    },\r\n    setController: function (controller) {\r\n        this.controller = controller;\r\n    },\r\n\r\n    initWithCellModels: function (cellsModels) {\r\n        this.cellViews = [];\r\n        for (var i = 1; i <= 9; i++) {\r\n            this.cellViews[i] = [];\r\n            for (var j = 1; j <= 9; j++) {\r\n                var type = cellsModels[i][j].type;\r\n                var aniView = cc.instantiate(this.aniPre[type]);\r\n                aniView.parent = this.node;\r\n                var cellViewScript = aniView.getComponent(\"CellView\");\r\n                cellViewScript.initWithModel(cellsModels[i][j]);\r\n                this.cellViews[i][j] = aniView;\r\n            }\r\n        }\r\n    },\r\n    setListener: function () {\r\n        // 添加点击事件\r\n        this.node.on(cc.Node.EventType.TOUCH_START, function (e) {\r\n            if (this.isInPlayAni) {//播放动画中，不允许点击\r\n                return true;\r\n            }\r\n            // 获取点击位置，通过点击位置推出点击元素坐标\r\n            let cellPos = this.convertTouchPosToCell(e.getLocation());\r\n            cellPos && this.selectCell(cellPos);\r\n            // 点击处有实际格子则可以移动\r\n            this.isCanMove = !!cellPos\r\n            return true;\r\n        }, this);\r\n        // 滑动操作逻辑\r\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, function (e) {\r\n            if (this.isCanMove) {\r\n                let startCellPos = this.convertTouchPosToCell(e.getStartLocation());\r\n                let cellPos = this.convertTouchPosToCell(e.getLocation());\r\n                if (startCellPos.x != cellPos.x || startCellPos.y != cellPos.y) {\r\n                    this.isCanMove = false;\r\n                    this.selectCell(cellPos);\r\n                }\r\n            }\r\n        }, this);\r\n    },\r\n    // 根据点击的像素位置，转换成网格中的位置(数学中的二维坐标轴)\r\n    convertTouchPosToCell: function (pos) {\r\n        pos = this.node.convertToNodeSpace(pos);\r\n        if (pos.x < 0 || pos.x >= GRID_PIXEL_WIDTH || pos.y < 0 || pos.y >= GRID_PIXEL_HEIGHT) {\r\n            return false;\r\n        }\r\n        var x = Math.floor(pos.x / CELL_WIDTH) + 1;\r\n        var y = Math.floor(pos.y / CELL_HEIGHT) + 1;\r\n        return cc.v2(x, y);\r\n    },\r\n    // 移动格子\r\n    updateView: function (changeModels) {\r\n        let newCellViewInfo = [];\r\n        for (var i in changeModels) {\r\n            var model = changeModels[i];\r\n            var viewInfo = this.findViewByModel(model);\r\n            var view = null;\r\n            // 如果原来的cell不存在，则新建\r\n            if (!viewInfo) {\r\n                var type = model.type;\r\n                var aniView = cc.instantiate(this.aniPre[type]);\r\n                aniView.parent = this.node;\r\n                var cellViewScript = aniView.getComponent(\"CellView\");\r\n                cellViewScript.initWithModel(model);\r\n                view = aniView;\r\n            }\r\n            // 如果已经存在\r\n            else {\r\n                view = viewInfo.view;\r\n                this.cellViews[viewInfo.y][viewInfo.x] = null;\r\n            }\r\n            var cellScript = view.getComponent(\"CellView\");\r\n            cellScript.updateView();// 执行移动动作\r\n            if (!model.isDeath) {\r\n                newCellViewInfo.push({\r\n                    model: model,\r\n                    view: view\r\n                });\r\n            }\r\n        }\r\n        // 重新标记this.cellviews的信息\r\n        newCellViewInfo.forEach(function (ele) {\r\n            let model = ele.model;\r\n            this.cellViews[model.y][model.x] = ele.view;\r\n        }, this);\r\n    },\r\n    // 显示选中的格子背景\r\n    updateSelect: function (pos) {\r\n        for (var i = 1; i <= 9; i++) {\r\n            for (var j = 1; j <= 9; j++) {\r\n                if (this.cellViews[i][j]) {\r\n                    var cellScript = this.cellViews[i][j].getComponent(\"CellView\");\r\n                    if (pos.x == j && pos.y == i) {\r\n                        cellScript.setSelect(true);\r\n                    }\r\n                    else {\r\n                        cellScript.setSelect(false);\r\n                    }\r\n\r\n                }\r\n            }\r\n        }\r\n\r\n    },\r\n    /**\r\n     * 根据cell的model返回对应的view\r\n     */\r\n    findViewByModel: function (model) {\r\n        for (var i = 1; i <= 9; i++) {\r\n            for (var j = 1; j <= 9; j++) {\r\n                if (this.cellViews[i][j] && this.cellViews[i][j].getComponent(\"CellView\").model == model) {\r\n                    return { view: this.cellViews[i][j], x: j, y: i };\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    },\r\n    getPlayAniTime: function (changeModels) {\r\n        if (!changeModels) {\r\n            return 0;\r\n        }\r\n        var maxTime = 0;\r\n        changeModels.forEach(function (ele) {\r\n            ele.cmd.forEach(function (cmd) {\r\n                if (maxTime < cmd.playTime + cmd.keepTime) {\r\n                    maxTime = cmd.playTime + cmd.keepTime;\r\n                }\r\n            }, this)\r\n        }, this);\r\n        return maxTime;\r\n    },\r\n    // 获得爆炸次数， 同一个时间算一个\r\n    getStep: function (effectsQueue) {\r\n        if (!effectsQueue) {\r\n            return 0;\r\n        }\r\n        return effectsQueue.reduce(function (maxValue, efffectCmd) {\r\n            return Math.max(maxValue, efffectCmd.step || 0);\r\n        }, 0);\r\n    },\r\n    //一段时间内禁止操作\r\n    disableTouch: function (time, step) {\r\n        if (time <= 0) {\r\n            return;\r\n        }\r\n        this.isInPlayAni = true;\r\n        this.node.runAction(cc.sequence(cc.delayTime(time), cc.callFunc(function () {\r\n            this.isInPlayAni = false;\r\n            this.audioUtils.playContinuousMatch(step);\r\n        }, this)));\r\n    },\r\n    // 正常击中格子后的操作\r\n    selectCell: function (cellPos) {\r\n        var result = this.controller.selectCell(cellPos); // 直接先丢给model处理数据逻辑\r\n        var changeModels = result[0]; // 有改变的cell，包含新生成的cell和生成马上摧毁的格子\r\n        var effectsQueue = result[1]; //各种特效\r\n        this.playEffect(effectsQueue);\r\n        this.disableTouch(this.getPlayAniTime(changeModels), this.getStep(effectsQueue));\r\n        this.updateView(changeModels);\r\n        this.controller.cleanCmd();\r\n        if (changeModels.length >= 2) {\r\n            this.updateSelect(cc.v2(-1, -1));\r\n            this.audioUtils.playSwap();\r\n        }\r\n        else {\r\n            this.updateSelect(cellPos);\r\n            this.audioUtils.playClick();\r\n        }\r\n        return changeModels;\r\n    },\r\n    playEffect: function (effectsQueue) {\r\n        this.effectLayer.getComponent(\"EffectLayer\").playEffects(effectsQueue);\r\n    }\r\n\r\n\r\n\r\n\r\n    // called every frame, uncomment this function to activate update callback\r\n    // update: function (dt) {\r\n\r\n    // },\r\n});\r\n"]}