{"version":3,"sources":["GridView.js"],"names":["cc","Class","extends","Component","properties","aniPre","default","type","Prefab","effectLayer","Node","audioUtils","AudioUtils","onLoad","setListener","lastTouchPos","Vec2","isCanMove","isInPlayAni","setController","controller","initWithCellModels","cellsModels","cellViews","i","j","aniView","instantiate","parent","node","cellViewScript","getComponent","initWithModel","on","EventType","TOUCH_START","eventTouch","touchPos","getLocation","cellPos","convertTouchPosToCell","changeModels","selectCell","length","TOUCH_MOVE","startTouchPos","getStartLocation","startCellPos","x","y","TOUCH_END","TOUCH_CANCEL","pos","convertToNodeSpace","GRID_PIXEL_WIDTH","GRID_PIXEL_HEIGHT","Math","floor","CELL_WIDTH","CELL_HEIGHT","v2","updateView","newCellViewInfo","model","viewInfo","findViewByModel","view","cellScript","isDeath","push","forEach","ele","updateSelect","setSelect","getPlayAniTime","maxTime","cmd","playTime","keepTime","getStep","effectsQueue","reduce","maxValue","efffectCmd","max","step","disableTouch","time","runAction","sequence","delayTime","callFunc","playContinuousMatch","result","playEffect","cleanCmd","playSwap","playClick","playEffects"],"mappings":"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","file":"GridView.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\Script\\View","sourcesContent":["import {CELL_WIDTH, CELL_HEIGHT, GRID_PIXEL_WIDTH, GRID_PIXEL_HEIGHT, ANITIME} from '../Model/ConstValue';\n\nimport AudioUtils from \"../Utils/AudioUtils\";\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        // foo: {\n        //    default: null,      // The default value will be used only when the component attaching\n        //                           to a node for the first time\n        //    url: cc.Texture2D,  // optional, default is typeof default\n        //    serializable: true, // optional, default is true\n        //    visible: true,      // optional, default is true\n        //    displayName: 'Foo', // optional\n        //    readonly: false,    // optional, default is false\n        // },\n        // ...\n        aniPre: {\n            default: [],\n            type: [cc.Prefab]\n        },\n        effectLayer: {\n            default: null,\n            type: cc.Node\n        },\n        audioUtils:{\n            type: AudioUtils,\n            default: null\n        }\n        \n    },\n\n\n    // use this for initialization\n    onLoad: function () {\n        this.setListener();\n        this.lastTouchPos = cc.Vec2(-1, -1);\n        this.isCanMove = true;\n        this.isInPlayAni = false; // 是否在播放中\n    },\n    setController: function(controller){\n        this.controller = controller;\n    },\n\n    initWithCellModels: function(cellsModels){\n        this.cellViews = [];\n        for(var i = 1;i<=9;i++){\n            this.cellViews[i] = [];\n            for(var j = 1;j<=9;j++){\n                var type = cellsModels[i][j].type;\n                var aniView = cc.instantiate(this.aniPre[type]);\n                aniView.parent = this.node;\n                var cellViewScript = aniView.getComponent(\"CellView\");\n                cellViewScript.initWithModel(cellsModels[i][j]);\n                this.cellViews[i][j] = aniView;\n            }\n        }\n    },\n    setListener: function(){\n        this.node.on(cc.Node.EventType.TOUCH_START, function(eventTouch){\n            if(this.isInPlayAni){//播放动画中，不允许点击\n                return true;\n            }\n            var touchPos = eventTouch.getLocation();\n            var cellPos = this.convertTouchPosToCell(touchPos);\n            if(cellPos){\n                var changeModels = this.selectCell(cellPos);\n                this.isCanMove = changeModels.length < 3;\n            }\n            else{\n                this.isCanMove = false;\n            }\n           return true;\n        }, this);\n        // 滑动操作逻辑\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, function(eventTouch){\n           if(this.isCanMove){\n               var startTouchPos = eventTouch.getStartLocation ();\n               var startCellPos = this.convertTouchPosToCell(startTouchPos);\n               var touchPos = eventTouch.getLocation();\n               var cellPos = this.convertTouchPosToCell(touchPos);\n               if(startCellPos.x != cellPos.x || startCellPos.y != cellPos.y){\n                   this.isCanMove = false;\n                   var changeModels = this.selectCell(cellPos); \n               }\n           }\n        }, this);\n        this.node.on(cc.Node.EventType.TOUCH_END, function(eventTouch){\n          // console.log(\"1111\");\n        }, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, function(eventTouch){\n          // console.log(\"1111\");\n        }, this);\n    },\n    // 根据点击的像素位置，转换成网格中的位置\n    convertTouchPosToCell: function(pos){\n        pos = this.node.convertToNodeSpace(pos);\n        if(pos.x < 0 || pos.x >= GRID_PIXEL_WIDTH || pos.y < 0 || pos.y >= GRID_PIXEL_HEIGHT){\n            return false;\n        }\n        var x = Math.floor(pos.x / CELL_WIDTH) + 1;\n        var y = Math.floor(pos.y / CELL_HEIGHT) + 1;\n        return cc.v2(x, y);\n    },\n    // 移动格子\n    updateView: function(changeModels){\n        let newCellViewInfo = [];\n        for(var i in changeModels){\n            var model = changeModels[i];\n            var viewInfo = this.findViewByModel(model);\n            var view = null;\n            // 如果原来的cell不存在，则新建\n            if(!viewInfo){\n                var type = model.type;\n                var aniView = cc.instantiate(this.aniPre[type]);\n                aniView.parent = this.node;\n                var cellViewScript = aniView.getComponent(\"CellView\");\n                cellViewScript.initWithModel(model);\n                view = aniView;\n            }\n            // 如果已经存在\n            else{\n                view = viewInfo.view;\n                this.cellViews[viewInfo.y][viewInfo.x] = null;\n            }\n            var cellScript = view.getComponent(\"CellView\");\n            cellScript.updateView();// 执行移动动作\n            if (!model.isDeath) {\n                newCellViewInfo.push({\n                    model: model,\n                    view: view\n                });\n            } \n        }\n        // 重新标记this.cellviews的信息\n        newCellViewInfo.forEach(function(ele){\n            let model = ele.model;\n            this.cellViews[model.y][model.x] = ele.view;\n        },this);\n    },\n    // 显示选中的格子背景\n    updateSelect: function(pos){\n         for(var i = 1;i <=9 ;i++){\n            for(var j = 1 ;j <=9 ;j ++){\n                if(this.cellViews[i][j]){\n                    var cellScript = this.cellViews[i][j].getComponent(\"CellView\");\n                    if(pos.x == j && pos.y ==i){\n                        cellScript.setSelect(true);\n                    }\n                    else{\n                        cellScript.setSelect(false);\n                    }\n\n                }\n            }\n        }\n        \n    },\n    /**\n     * 根据cell的model返回对应的view\n     */\n    findViewByModel: function(model){\n        for(var i = 1;i <=9 ;i++){\n            for(var j = 1 ;j <=9 ;j ++){\n                if(this.cellViews[i][j] && this.cellViews[i][j].getComponent(\"CellView\").model == model){\n                    return {view:this.cellViews[i][j],x:j, y:i};\n                }\n            }\n        }\n        return null;\n    },\n    getPlayAniTime: function(changeModels){\n        if(!changeModels){\n            return 0;\n        }\n        var maxTime = 0;\n        changeModels.forEach(function(ele){\n            ele.cmd.forEach(function(cmd){\n                if(maxTime < cmd.playTime + cmd.keepTime){\n                    maxTime = cmd.playTime + cmd.keepTime;\n                }\n            },this)\n        },this);\n        return maxTime;\n    },\n    // 获得爆炸次数， 同一个时间算一个\n    getStep: function(effectsQueue){\n        if(!effectsQueue){\n            return 0;\n        }\n        return effectsQueue.reduce(function(maxValue, efffectCmd){\n            return Math.max(maxValue, efffectCmd.step || 0);\n        }, 0);\n    },\n    //一段时间内禁止操作\n    disableTouch: function(time, step){\n        if(time <= 0){\n            return ;\n        }\n        this.isInPlayAni = true;\n        this.node.runAction(cc.sequence(cc.delayTime(time),cc.callFunc(function(){\n            this.isInPlayAni = false;\n            this.audioUtils.playContinuousMatch(step);\n        }, this)));\n    },\n    // 正常击中格子后的操作\n    selectCell: function(cellPos){\n        var result = this.controller.selectCell(cellPos); // 直接先丢给model处理数据逻辑\n        var changeModels = result[0]; // 有改变的cell，包含新生成的cell和生成马上摧毁的格子\n        var effectsQueue = result[1]; //各种特效\n        this.playEffect(effectsQueue);\n        this.disableTouch(this.getPlayAniTime(changeModels), this.getStep(effectsQueue));\n        this.updateView(changeModels);\n        this.controller.cleanCmd(); \n        if(changeModels.length >= 2){\n            this.updateSelect(cc.v2(-1,-1));\n            this.audioUtils.playSwap();\n        }\n        else{\n            this.updateSelect(cellPos);\n            this.audioUtils.playClick();\n        }\n        return changeModels;\n    },\n    playEffect: function(effectsQueue){\n        this.effectLayer.getComponent(\"EffectLayer\").playEffects(effectsQueue);\n    }\n\n\n\n\n    // called every frame, uncomment this function to activate update callback\n    // update: function (dt) {\n\n    // },\n});\n"]}